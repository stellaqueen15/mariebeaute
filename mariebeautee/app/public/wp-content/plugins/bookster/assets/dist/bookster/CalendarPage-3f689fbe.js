import{c as e,R as t,b as a,a as r,_ as n,d as s,r as o,L as l,e as i,q as c,f as m}from"./prefetch.helper-4a4e89e7.js";import{u,S as p,a as d,b as f,C as E,m as b,r as v,c as g,e as w,d as h}from"./CalendarNav.styled-1832bdf1.js";import{P as j}from"./UIComponents-1eb3bdbf.js";import{A as C,N as y}from"./NestedCustomerDrawer-16c9e791.js";import{k}from"./DeleteAppointmentButton-e4b7a1de.js";import{m as A,a as S}from"./main-38921655.js";import{m as _}from"./main-a21b2a58.js";import{u as x,h as F}from"./store-87403b6b.js";import{u as N,a as P}from"./useAgentResources-9dd36330.js";import{S as R,P as T}from"./queue.helper-9ff85512.js";import{e as M,u as I}from"./BEConfigProvider-697f66d7.js";import{d as D}from"./appointment.helper-80ab8c9c.js";import{A as B}from"./ApptsFilterAgent-6f9c73b0.js";import{A as V,a as H,b as O}from"./ApptsFilterService-7f63b074.js";import"./index-f9ec547e.js";import"./index-ad7a2af3.js";import"./index-db6d4b60.js";import"./index-8ef1ff47.js";import"./useEffectWithTarget-688d6bb0.js";import"./CustomerFormContent-cbddc6fa.js";import"./phoneInput.helper-24509875.js";import"./index-f3d162c1.js";import"./AvatarPicker-e9de6b9b.js";import"./HiddenInput-2f0ce489.js";import"./customer.helper-d5537c29.js";import"./createBookTimeInput.helper-a66a36a8.js";import"./useBreakpoint-2ef0bad1.js";import"./holiday.helper-ca9c72dc.js";function Q({isFetching:o,isSaving:l,...i}){const{getCalendarApi:c}=u(),{title:m,type:p}=x((e=>e.calendar.view)),d=x((e=>e.calendarToday)),f=x((e=>e.calendarPrev)),E=x((e=>e.calendarNext)),b=x((e=>e.calendarChangeView)),v=e.useQueryClient(),[g,w]=e.useSearchParams(),h=e.usePublicActiveAgents();return t.createElement(t.Fragment,null,t.createElement(W,{...i},t.createElement(G,{onClick:()=>d(c())},a.__("Today","bookster")),t.createElement("div",{className:"bw-mr-1 bw-inline-flex -bw-space-x-px"},t.createElement(q,{onClick:()=>f(c())},t.createElement(r.ChevronLeft,{className:"bw-h-5 bw-w-5"})),t.createElement(q,{onClick:()=>E(c())},t.createElement(r.ChevronRight,{className:"bw-h-5 bw-w-5"}))),t.createElement(L,null,m," ",t.createElement(R,{isSaving:l})),t.createElement(K,{onClick:()=>v.invalidateQueries({queryKey:["appointments","events"]})},t.createElement(r.RefreshCw,{className:o?"bw-animate-spin":""})),t.createElement(n.Select,{value:p,onValueChange:e=>{M({calendarViewManager:e}),function(e){!g.get("agent")&&!g.get("service")&&!g.get("customer")&&h.length>0&&"resourceTimelineDay"!==e&&w((e=>(e.set("agent",`${h[0].agent_id}`),e))),b(c(),e)}(e)}},t.createElement(n.SelectTrigger,{className:"bw-w-32",withStatus:!1},t.createElement(n.SelectValue,null)),t.createElement(n.SelectContent,null,t.createElement(n.SelectItem,{value:"dayGridMonth"},a.__("Month View","bookster")),t.createElement(n.SelectItem,{value:"timeGridWeek"},a.__("Week View","bookster")),t.createElement(n.SelectItem,{value:"resourceTimelineDay"},a.__("Day View","bookster"))))),t.createElement("div",{className:"bw-mb-3 bw-flex bw-flex-row bw-flex-wrap bw-items-center bw-gap-2"},t.createElement("span",{className:"bw-text-lg bw-font-semibold bw-text-base-foreground/80"},"Filters"),t.createElement(n.Separator,{orientation:"vertical",className:"bw-h-6 bw-bg-base-border"}),t.createElement(B,null),t.createElement(V,null),t.createElement(H,null),s.booksterHooks.applyFilters(s.HOOK_NAMES.adminCalendar.BeforeApptsFilterClear,[]),t.createElement(O,null)))}const{Wrapper:W,NavButton:q,Title:L,TodayButton:G,ReloadButton:K}=p,U=new T;function $(){const{activeStart:a,activeEnd:r,type:s}=x((e=>e.calendar.view)),m=x((e=>e.initAppointmentForm)),[p,h]=o.useState(null),j=x((e=>e.calendarRefresh)),{toast:C}=n.useToast(),{resources:y,slotMinAbs:k,slotMaxAbs:R}=N(),[T]=e.useSearchParams(),M=T.get("agent"),{invalidateLazy:B,invalidateNow:V,updateModel:H}=d(),O=f(a,r),{data:W,isFetching:q,isRefetching:L}=P(O),{getCalendarApi:G,calendarRef:K}=u();o.useEffect((()=>{if(void 0!==W&&K.current){const e=G();e.batchRendering((()=>{e.removeAllEvents(),W.forEach((t=>e.addEvent(t)))}))}}),[W,K.current]),o.useEffect((()=>{if(void 0!==y&&K.current){const e=G();let t=y;if(M){const e=M.split(",");t=t.filter((t=>e.includes(t.id)))}e.batchRendering((()=>{e.getResources().forEach((e=>e.remove())),t.forEach((t=>e.addResource(t)))}))}}),[y,M,K.current]),o.useEffect((()=>{j(G())}),[]);const $=e.useQueryClient(),z=I();return t.createElement(t.Fragment,null,t.createElement(Q,{isSaving:p,className:"bw-mb-4",isFetching:q||L}),t.createElement(E,{key:"manager-calendar",plugins:[A,S,_,b],initialView:s,allDaySlot:!1,slotMinTime:60*k*1e3,slotMaxTime:60*R*1e3,resourceAreaHeaderContent:l.agents,resourceAreaWidth:260,resourceLabelContent:v,eventContent:g,dateClick:function(e){if("fc-non-business"===e.jsEvent.target.className)return;const t=i._dayjs.utc(e.date).utcOffset(i.USER_UTC_OFFSET,!0);var a;a={book_date:t,start_time:"dayGridMonth"===s?c.Helper.booktime.createFromAbsMinute(w.slotMinAbs):c.Helper.booktime.createFromDayjs(t),agent_ids:e.resource?[parseInt(e.resource.id)]:[]},m(a),z("new")},eventClick:async function(e){var t;e.jsEvent.preventDefault(),t=e.event.extendedProps.model,$.setQueryData(["appointment",t.appointment_id],t),z(`${t.appointment_id}`)},eventDrop:async function(t){const a=t.event;if(!a.start||!a.end)return;const r=D(a.extendedProps.model,a.start,a.end),n=t.newResource;n&&(r.agent_ids=[parseInt(n.id)]),U.add((async()=>{h(!0);try{const e=await F(parseInt(t.event.id),r);t.event.setExtendedProp("model",e),H(e),B()}catch(a){throw h(null),C.error(await e.getErrorMsg(a)),V(),t.revert(),a}}),(()=>{h(!1)}))},editable:!0}))}function z(){const[a]=m.Form.useForm();return t.createElement(j,null,t.createElement(h,null,t.createElement($,null)),t.createElement(k.Provider,{value:{form:a}},t.createElement(C,{parentPath:"/calendar"},t.createElement(e.Outlet,null)),t.createElement(y,null)))}export{z as default};
