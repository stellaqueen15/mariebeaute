import{c as e,r as t,R as r,_ as a,a as s,b as i,L as n,f as o}from"./prefetch.helper-4a4e89e7.js";import{u as c,A as l}from"./store-87403b6b.js";import{S as u,r as d,P as m}from"./queue.helper-9ff85512.js";import{a as v}from"./UIComponents-1eb3bdbf.js";import{S as b,A as g}from"./ServiceCard-c25895f8.js";import{u as y,f as w,h as _}from"./BEConfigProvider-697f66d7.js";import{u as f}from"./useServiceFormContext-e5a256c1.js";async function p(t){return await e.api.post("services_categories",{json:t}).json()}async function E(t){return await e.api.delete(`services_categories/${t}`).json()}function C({service:s,className:i,...n}){const{setNodeRef:o,attributes:c,listeners:l,transition:u,transform:d,isDragging:m}=e.useSortable({id:`service-${s.service_id}`,data:{type:"service",service:s}}),v={transition:u,transform:e.dndCSS.Transform.toString(d)},b=e.useQueryClient(),w=y(),_=t.useCallback((e=>{e.stopPropagation(),w(`${s.service_id}`),b.setQueryData(["service",s.service_id],s)}),[s]),f=t.useMemo((()=>r.createElement(g,{service:s})),[s]);return m?r.createElement("div",{ref:o,className:"bw-rounded-lg bw-bg-base-bg2 bw-ring-2 bw-ring-base-border",style:v},r.createElement(x,{className:"bw-opacity-0",service:s,serviceDescription:f})):r.createElement("div",{className:a.cx("bw-rounded-lg bw-bg-base-bg1",i),style:v,ref:o,...c,...l,...n},r.createElement(x,{service:s,serviceDescription:f,onClick:_}))}const x=t.memo(b);function h({cate:o,className:l,...u}){const d=c((e=>e.editServiceNestedCategory)),m=c((e=>e.initServiceForm)),[v,b]=t.useState(500),g=e.useQueryClient(),w=y(),_=t.useRef(null);t.useEffect((()=>{_.current&&b(_.current.clientHeight)}),[o.services.length]);const f=t.useMemo((()=>o.services.map((e=>`service-${e.service_id}`))),[o.services]),{setNodeRef:p,attributes:E,listeners:x,transition:h,transform:S,isDragging:N}=e.useSortable({id:`cate-${o.service_category_id}`,data:{type:"cate",cate:o}}),k={transition:h,transform:e.dndCSS.Transform.toString(S)};return N?r.createElement("div",{ref:p,style:k,className:"bw-flex bw-h-full bw-w-72"},r.createElement("div",{className:"bw-w-full bw-rounded bw-bg-base-bg3",style:{height:v}})):r.createElement("div",{ref:p,className:"bw-h-full"},r.createElement("div",{ref:_,style:k,className:a.cx("bw-flex bw-max-h-full bw-w-72 bw-flex-col bw-rounded bw-border bw-border-solid bw-border-base-border bw-bg-base-bg1 bw-shadow-sm",l),...u},r.createElement("div",{className:"btr-click-trigger bw-flex bw-flex-none bw-cursor-pointer bw-items-center bw-border-0 bw-border-b bw-border-solid bw-border-base-border bw-px-4 bw-py-2 bw-text-lg",onClick:e=>{e.stopPropagation(),g.setQueryData(["serviceCategory",o.service_category_id],o),d(o.service_category_id)},...E,...x},o.name,r.createElement(s.SquarePen,{className:"btr-form-outlined bw-ml-2 -bw-translate-x-2 bw-text-primary bw-opacity-0 bw-transition-all"})),r.createElement("div",{className:"btr-scrollbar-sm bw-flex bw-flex-grow bw-flex-col bw-gap-3 bw-overflow-y-auto bw-p-3 bw-pb-1"},r.createElement(e.SortableContext,{items:f},o.services.map((e=>r.createElement(C,{key:e.service_id,service:e}))))),r.createElement("div",{className:"bw-m-3 bw-mt-2 bw-flex bw-flex-none bw-cursor-pointer bw-items-center bw-justify-center bw-gap-2 bw-rounded-xl bw-bg-primary/20 bw-py-1 bw-text-sm bw-text-base-foreground bw-transition-colors bw-duration-300 hover:bw-bg-primary/80 hover:bw-text-primary-foreground",onClick:()=>{return e=o.service_category_id,m({service_category_id:e}),void w("new");var e}},r.createElement(s.Plus,null)," ",i.sprintf(i.__("New %(service)s","bookster"),n))))}function S(e,t,r,a,s){const i=[...e];if(t===a){if(r===s)return e;const a={...i[t]},n=[...i[t].services],o=n.splice(r,1);return n.splice(s,0,...o),a.services=n,i[t]=a,i}const n={...i[t]},o={...i[a]},c=o.service_category_id,l=[...n.services],u=[...o.services],d=l.splice(r,1).map((e=>({...e,service_category_id:c})));return u.splice(s,0,...d),n.services=l,o.services=u,i[t]=n,i[a]=o,i}const N=new m,k="service",D="cate";function F(){const i=e.useQueryClient(),o=c((e=>e.newServiceNestedCategory)),{data:m,isLoading:b}=e.useAllServicesQuery(),g=void 0===m?[]:m,{toast:y}=a.useToast(),[w,_]=t.useState(void 0),[f,p]=t.useState(void 0),[E,x]=t.useState(null),F=e.useSensors(e.useSensor(e.PointerSensor,{activationConstraint:{distance:5}}));function I(e){i.setQueryData(["services","group_by_category"],e)}const Q=t.useMemo((()=>g?g.map((e=>`cate-${e.service_category_id}`)):[]),[g]);return r.createElement(r.Fragment,null,r.createElement(v.Wrapper,{className:"bw-px-5 bw-py-4"},r.createElement(v.Title,{className:"bw-flex bw-items-center"},n.services,r.createElement(u,{isSaving:E}))),r.createElement("div",{className:"btr-scrollbar-md bw-flex-grow bw-overflow-x-auto bw-px-5 bw-pb-4"},r.createElement("div",{className:"bw-flex bw-h-full bw-w-fit bw-flex-nowrap bw-items-start bw-gap-3"},r.createElement(e.DndContext,{sensors:F,onDragStart:function(e){var t,r;(null==(t=e.active.data.current)?void 0:t.type)!==D?(null==(r=e.active.data.current)?void 0:r.type)!==k||p(e.active.data.current.service):_(e.active.data.current.cate)},onDragEnd:function(t){var r,a,s,n,o,c;const{active:u}=t,d=null==(r=u.data.current)?void 0:r.type;if(d===k){const t=null==(a=u.data.current)?void 0:a.service.service_category_id,r=g.findIndex((e=>e.service_category_id===t)),o=null==(s=u.data.current)?void 0:s.service.service_id;let c=g[r].services.findIndex((e=>e.service_id===o));c++;const d=null==(n=u.data.current)?void 0:n.service.position;(null==f?void 0:f.service_category_id)===t&&d===c||async function(t,r,a){N.add((async()=>{try{x(!0),await l(t,r,a)}catch(s){throw x(null),y.error(await e.getErrorMsg(s)),s}}),(()=>{x(!1),i.invalidateQueries(["services","group_by_category"])}))}(o,t,c)}if(d===D){const t=null==(o=u.data.current)?void 0:o.cate.service_category_id;let r=g.findIndex((e=>e.service_category_id===t));r++,(null==(c=u.data.current)?void 0:c.cate.position)!==r&&async function(t,r){N.add((async()=>{try{x(!0),await async function(t,r){return await e.api.patch(`services_categories/${t}/update_position`,{json:{position:r}}).json()}(t,r)}catch(a){throw x(null),y.error(await e.getErrorMsg(a)),a}}),(()=>{x(!1),i.invalidateQueries(["services","group_by_category"])}))}(t,r)}_(void 0),p(void 0)},onDragOver:function(e){var t,r,a,s,i,n,o,c,l,u;const{active:d,over:m}=e;if(!m)return;const v=null==(t=d.data.current)?void 0:t.type,b=null==(r=m.data.current)?void 0:r.type;if(g){if(v===k){const e=null==(a=d.data.current)?void 0:a.service.service_category_id,t=g.findIndex((t=>t.service_category_id===e)),r=null==(s=d.data.current)?void 0:s.service.service_id,c=g[t].services.findIndex((e=>e.service_id===r));if(b===k){const e=null==(i=m.data.current)?void 0:i.service.service_category_id,a=g.findIndex((t=>t.service_category_id===e)),s=null==(n=m.data.current)?void 0:n.service.service_id,o=g[a].services.findIndex((e=>e.service_id===s));if(r===s)return g;I(S(g,t,c,a,o))}if(b===D){const r=null==(o=m.data.current)?void 0:o.cate.service_category_id;if(e===r)return g;const a=g.findIndex((e=>e.service_category_id===r));return void I(S(g,t,c,a,0))}}if(v===D){const e=null==(c=d.data.current)?void 0:c.cate.service_category_id,t=g.findIndex((t=>t.service_category_id===e)),r=b===k?null==(l=m.data.current)?void 0:l.service.service_category_id:null==(u=m.data.current)?void 0:u.cate.service_category_id,a=g.findIndex((e=>e.service_category_id===r));I(function(e,t,r){if(t===r)return e;const a=[...e],s=a.splice(t,1);return a.splice(r,0,...s),a}(g,t,a))}}}},r.createElement(e.SortableContext,{items:Q},g&&g.map((e=>r.createElement(h,{key:e.service_category_id,cate:e})))),d.createPortal(r.createElement(e.DragOverlay,{className:"bookster-root"},w&&r.createElement(h,{className:"bw-rotate-3 bw-opacity-90 bw-shadow-md",cate:w}),f&&r.createElement(C,{className:"bw-opacity-90",service:f})),document.body)),!b&&r.createElement("div",{className:"bw-flex bw-w-72 bw-cursor-pointer bw-items-center bw-justify-center bw-gap-2 bw-rounded bw-bg-primary/20 bw-px-4 bw-py-2 bw-text-lg bw-transition-all bw-duration-300 hover:bw-bg-primary/90 hover:bw-text-primary-foreground",onClick:()=>o()},r.createElement(s.Plus,null),"New Category"))))}function I(){return r.createElement(r.Fragment,null,r.createElement(o.Form.Item,{name:"name",label:i.__("Category Name","bookster"),rules:[{required:!0}]},r.createElement(a.Input,{placeholder:i.__("Please enter category name","bookster"),autoFocus:!0})),r.createElement(o.Form.Item,{name:"description",label:i.__("Category Description","bookster")},r.createElement(a.Textarea,{rows:4,maxLength:150,placeholder:i.__("Please enter category description","bookster")})))}function Q(){const[e]=o.Form.useForm();return r.createElement(r.Fragment,null,r.createElement(a.DialogTitle,null,i.__("Closing","bookster")),r.createElement(a.DialogCloseIcon,null),r.createElement(o.Form,{form:e,disabled:!0,layout:"vertical"},r.createElement(I,null)),r.createElement(a.DialogFooter,null,r.createElement(a.ReactDialog.Close,{asChild:!0},r.createElement(a.Button,{key:"back",tabIndex:-1,variant:"trivial"},i.__("Cancel","bookster"))),r.createElement(a.Button,{key:"submit"},i.__("Save","bookster"))))}function j({service_category_id:t,onDelete:n,disabled:o}){var c;const l=e.useAllServices(),u=!l,d=0===(null==(c=l.find((e=>e.service_category_id===t)))?void 0:c.services.length);return r.createElement(a.ReactPopover.Root,{key:"delete"},r.createElement(a.ReactPopover.Trigger,{asChild:!0},r.createElement(a.Button,{className:"bw-mr-auto msm:bw-hidden",disabled:o||u||!d,size:"icon",color:"error",variant:"outline",tabIndex:-1},r.createElement(s.Trash,null))),r.createElement(w,null,r.createElement("div",{className:"bw-flex bw-items-start bw-gap-2"},r.createElement(s.Info,{className:"bw-h-5 bw-w-5 bw-fill-warning bw-text-base-bg1"}),r.createElement("span",null,i.__("Are You Sure to delete this category?","bookster"))),r.createElement(_,null,r.createElement(a.ReactPopover.Close,{asChild:!0},r.createElement(a.Button,{variant:"trivial",size:"small"},i.__("Cancel","bookster"))),r.createElement(a.ReactPopover.Close,{asChild:!0},r.createElement(a.Button,{color:"error",variant:"outline",size:"small",onClick:()=>{o||u||!d||n()}},i.__("Delete","bookster"))))))}function P(){const s=c((e=>e.closeServiceNestedCategory)),[,l]=c((e=>e.services.form.nestedCategory)),u=isNaN(Number(l))?null:Number(l),{data:d,isLoading:m}=function(t){return e.useQuery({queryKey:["serviceCategory",t],queryFn:()=>t?async function(t){return await e.api.get(`services_categories/${t}`).json()}(t):null,staleTime:0})}(u),{toast:v}=a.useToast(),[b]=o.Form.useForm(),g=e.useQueryClient(),y=e.useMutation({mutationKey:["serviceCategories",u,"edit"],mutationFn:({id:t,values:r})=>async function(t,r){return await e.api.patch(`services_categories/${t}`,{json:r}).json()}(t,r),onSuccess:e=>{g.setQueryData(["serviceCategory",e.service_category_id],e),g.invalidateQueries({queryKey:["services"]})}}),w=e.useMutation({mutationKey:["serviceCategories",u,"delete"],mutationFn:E,onSuccess:()=>{g.removeQueries({queryKey:["serviceCategory",u]}),g.invalidateQueries({queryKey:["services"]})}});t.useEffect((()=>{d&&(b.resetFields(),b.setFieldsValue(d))}),[d]);const _=m||!d&&!m||y.isLoading||w.isLoading;return r.createElement(r.Fragment,null,r.createElement(a.DialogTitle,null,i.sprintf(i.__("Edit %(service)s Category","bookster"),n)),r.createElement(a.DialogCloseIcon,null),r.createElement(a.LoadingOverlay,{loading:_}),r.createElement(o.Form,{form:b,disabled:_,layout:"vertical",onFinish:t=>{!async function(t){if(u&&d)try{await y.mutateAsync({id:d.service_category_id,values:t}),v.success("Category has been Saved Successfully!"),s()}catch(r){v.error(await e.getErrorMsg(r))}}(t)}},r.createElement(I,null)),r.createElement(a.DialogFooter,null,d?r.createElement(j,{disabled:_,service_category_id:d.service_category_id,onDelete:async function(){if(u&&d)try{await w.mutateAsync(d.service_category_id),v.success("Category has been Deleted Successfully!"),s()}catch(t){v.error(await e.getErrorMsg(t))}}}):null,r.createElement(a.ReactDialog.Close,{asChild:!0},r.createElement(a.Button,{key:"back",variant:"trivial",tabIndex:-1},i.__("Cancel","bookster"))),r.createElement(a.Button,{key:"submit",disabled:_,onClick:()=>b.submit()},i.__("Save","bookster"))))}function R(){const t=c((e=>e.closeServiceNestedCategory)),{toast:s}=a.useToast(),{form:l}=f(),[u]=o.Form.useForm(),d=e.useQueryClient(),m=e.useMutation({mutationKey:["serviceCategories","new"],mutationFn:p,onSuccess:e=>{d.setQueryData(["serviceCategory",e.service_category_id],e),d.invalidateQueries({queryKey:["services"]})}}),v=M;return r.createElement(r.Fragment,null,r.createElement(a.DialogTitle,null,i.sprintf(i.__("New %(service)s Category","bookster"),n)),r.createElement(a.DialogCloseIcon,null),r.createElement(a.LoadingOverlay,{loading:m.isLoading}),r.createElement(o.Form,{form:u,initialValues:v,disabled:m.isLoading,layout:"vertical",onFinish:r=>{!async function(r){try{const e=await m.mutateAsync(r);s.success("Category has been Saved Successfully!"),t(),l.setFieldsValue({service_category_id:e.service_category_id})}catch(a){s.error(await e.getErrorMsg(a))}}(r)}},r.createElement(I,null)),r.createElement(a.DialogFooter,null,r.createElement(a.ReactDialog.Close,{asChild:!0},r.createElement(a.Button,{key:"back",variant:"trivial",tabIndex:-1},i.__("Cancel","bookster"))),r.createElement(a.Button,{key:"submit",disabled:m.isLoading,onClick:()=>u.submit()},i.__("Save","bookster"))))}const M={name:"",description:""};function T(){const[t]=c((e=>e.services.form.nestedCategory)),s=c((e=>e.closeServiceNestedCategory)),i=e.useIsMutating({mutationKey:["serviceCategories"]});return r.createElement(a.ReactDialog.Root,{open:"close"!==t,onOpenChange:e=>{e||i||s()}},r.createElement(a.Dialog,null,"close"===t&&r.createElement(Q,null),"new"===t&&r.createElement(R,null),"edit"===t&&r.createElement(P,null)))}function K({children:t}){const s=e.useMatch("/services/list"),i=y(),n=c((e=>e.resetServiceForm)),o=null===s,l=e.useIsMutating({mutationKey:["services"]});return r.createElement(a.DrawerRoot,{open:o,onOpenChange:e=>{e||l||(i("."),n())}},r.createElement(a.Drawer,null,t))}export{F as K,T as N,K as S};
